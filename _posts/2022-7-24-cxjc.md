---
layout: post
title: "Docker + JenkinsæŒç»­é›†æˆ"
author: "Fanqiang Meng"
categories: journal
tags: [documentation]
# image: DSC_0803.JPG

---

è®°å½•ä¸€ä¸‹åŸºäº`Docker | Jenkins | Github` å®ç°çš„æŒç»­é›†æˆ
## æ‹‰å–Jenkinsé•œåƒï¼Œè¿è¡Œå®¹å™¨
> ğŸ’¡ Tipsï¼šå¦‚æœéœ€è¦ç”¨åˆ°å®¿ä¸»æœºdockerå‘½ä»¤è®°å¾—æ˜ å°„

```bash
# æ‹‰å– Jenkins æ‹‰å–é•œåƒï¼Œè¿™é‡Œä½¿ç”¨æ”¯æŒ JDK8 çš„ç‰ˆæœ¬ã€‚
docker pull jenkins/jenkins:latest-jdk8

# è¿è¡Œå®¹å™¨
docker run -u root -d  --name dp-jenkins  jenkins/jenkins:latest-jdk8


docker run -u root -d -p 9999:8080 -v /var/run/docker.sock:/var/run/docker.sock  -v /usr/bin/docker:/usr/bin/docker --name docker-jenkins jenkins/jenkins:latest-jdk8
```
### æ˜ å°„å®¿ä¸»æœºDocker
```bash
-v /var/run/docker.sock:/var/run/docker.sock 

-v /usr/bin/docker:/usr/bin/docker
```
## é…ç½®Jenkins
> ğŸ’¡ Tipsï¼š8080ç«¯å£ä¸ºjenkinsæœåŠ¡é»˜è®¤çš„webè®¿é—®ç«¯å£ ï¼Œ-pæ˜ å°„å®¿ä¸»æœºçš„æŒ‡å®šç«¯å£

**è®¿é—®æœåŠ¡å™¨åœ°å€çš„å®¹å™¨æ˜ å°„ç«¯å£æŸ¥çœ‹jenkinsæœåŠ¡**
é¦–æ¬¡ç™»å½•éœ€è¦é»˜è®¤å¯†ç 
åœ¨å®¹å™¨ç»ˆç«¯åˆ°æç¤ºçš„å¯¹åº”ç›®å½•ä¸‹ä½¿ç”¨ `cat` å‘½ä»¤æŸ¥çœ‹**åˆå§‹å¯†ç **
ç™»å½•åä¼šæç¤ºå®‰è£…æ’ä»¶ï¼Œæˆ‘ç›´æ¥å®‰è£…é€šç”¨çš„æ’ä»¶
## åˆ›å»ºJenkinsä»»åŠ¡
ç®€å•çš„é…ç½®ä¸‹ä»»åŠ¡ï¼Œå°±æ˜¯é¡¹ç›®çš„åœ°å€ï¼Œè¿˜æœ‰è´¦å·å¯†ç æˆ–è€…å¯†é’¥è¿™äº›
é…ç½®å®Œå°±å¯ä»¥å°è¯•æ‰‹åŠ¨æ„å»ºäº†
æŸ¥çœ‹æ—¥å¿—è¾“å‡ºæ˜¯å¦æ„å»ºæˆåŠŸ
æ„å»ºæˆåŠŸï¼Œåœ¨`Workspace` ä¸­å°±å¯ä»¥çœ‹åˆ°æ‹‰ä¸‹æ¥çš„é¡¹ç›®äº†
## é…ç½®æ–‡ä»¶
### dockerfileé…ç½®
```bash
# ä¾èµ– nginx å®¹å™¨
FROM nginx
# ä½œè€…
MAINTAINER joshuaaam
# é¦–å…ˆåˆ é™¤ nginx default.conf æ–‡ä»¶
# RUN rm /etc/nginx/conf.d/default.conf
# ç”¨æœ¬åœ°çš„ default.conf æ›¿æ¢ nginx é•œåƒçš„é»˜è®¤é…ç½®
# ADD default.conf /etc/nginx/conf.d/
# å°†é¡¹ç›®æ‰“åŒ…åçš„ dist ç›®å½•ï¼Œæ‹·è´åˆ° default.conf æŒ‡å®šçš„å‘å¸ƒç›®å½• 
COPY _site/ /usr/share/nginx/html/
```
## Jenkinsæ„å»ºæ‰§è¡Œshell

```bash
# åˆ é™¤å†å²é•œåƒ

current_img=$(docker images | grep jekll-image | awk '{print $3}')
current_con=$(docker ps -a | awk '/jekll-image/ {print $1}')

if [ -z "$current_con" ]
then
      echo "\$current_con is empty"
else
      echo "\$current_con is NOT empty"
      docker rmi --force $current_con
fi

if [ -z "$current_img" ]
then
      echo "\$current_img is empty"
else
      echo "\$current_img is NOT empty"
      docker rmi --force $current_img
fi

# æ„å»ºé•œåƒ  -t é•œåƒå -f æŒ‡å®šæ„å»ºæ–‡ä»¶  
docker build . -t jekyll-image -f ./dockerfile

# æ¨é€é•œåƒ
# docker push jekyll-image

# å¯åŠ¨å®¹å™¨
docker run --name jekyll_web -p 9998:80  -d -i jekyll-image
```

é‡æ–°æ‰‹åŠ¨æ„å»ºåè®¿é—®å¯¹åº”çš„æ˜ å°„ç«¯å£å°±å¯ä»¥çœ‹åˆ°é¡¹ç›®äº†
> ğŸ’¡ Tipsï¼šè¿™é‡Œè¦å…ˆé…ç½®å¥½åŸŸåçš„è½¬å‘


## github webhook

1. githubç”Ÿæˆå¯†é’¥

ç™»é™†Githubï¼Œè¿›å…¥ `settings` é¡µé¢ï¼Œé€‰æ‹© `Developer settings` ä¸­çš„`Personnal access tokens` ï¼Œç”Ÿæˆå¯†é’¥

<img src="{{site.url}}/assets/img/2022-7-24/005.png"/>

2. Jenkinså…¨å±€é…ç½®

å°†å¯†é’¥è®¾ç½®åœ¨Jenkinså…¨å±€é…ç½®ä¸­

3. Githubé…ç½®webhookï¼Œåœ¨é¡¹ç›®çš„settingsä¸­é…ç½®webhookå°±æ˜¯jenkinséƒ¨ç½²çš„åœ°å€ :) `ä¾‹ï¼šhttp://ip:ç«¯å£/github-webhook/`
> ğŸ’¡ æ³¨æ„ï¼šç»“å°¾çš„/åˆ«å¿˜äº†åŠ 


<img src="{{site.url}}/assets/img/2022-7-24/001.png"/>

4. Jenkinsä»»åŠ¡é…ç½®

<img src="{{site.url}}/assets/img/2022-7-24/002.png"/>

<img src="{{site.url}}/assets/img/2022-7-24/003.png"/>

<img src="{{site.url}}/assets/img/2022-7-24/006.png"/>

è¿™é‡Œçš„Secret textå°±æ˜¯Githubç”Ÿæˆçš„å¯†é’¥

å®Œäº‹æäº¤ä»£ç ï¼Œå°±å¯ä»¥çœ‹åˆ°ä»»åŠ¡è‡ªåŠ¨å¼€å§‹æ„å»ºäº†







## è¸©å‘

- **åœ¨**`**docker1.13.1**`** ä¸­ï¼Œ jenkinsæ„å»ºä¸­æ‰§è¡Œshellä½¿ç”¨dokcer å‘½ä»¤æŠ¥é”™ Can't open /etc/sysconfig/docker**

**åŸå› ï¼š**docker1.13.1  /usr/bin/ ä¸‹çœŸæ­£çš„binaryæ˜¯ docker-currentï¼Œæ˜ å°„è·¯å¾„åº”è¯¥ä¸º` -v /usr/bin/docker-current:/usr/bin/docker` 

- **æ²¡æœ‰åŠ æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„**

 docker build æ„å»ºé•œåƒè¦è®°å¾—åŠ ä¸Šæ„å»ºè·¯å¾„ï¼Œé»˜è®¤ `Dockerfile` ä¸ºæ„å»ºæ–‡ä»¶ï¼Œ-fï¼ˆæŒ‡å®šæ„å»ºæ–‡ä»¶ï¼‰-t (æŒ‡å®šé•œåƒå)

- **iptable è§„åˆ™ä¸¢å¤±ï¼Œç«¯å£æ˜ å°„å¤±æ•ˆ**

å› ä¸ºé‡å¯é˜²ç«å¢™ï¼Œå¯¼è‡´ `iptables`  è§„åˆ™ä¸¢å¤±ï¼Œç«¯å£æ˜ å°„å¤±æ•ˆï¼Œé‡å¯å®¹å™¨ä¹ŸæŠ¥é”™
Error response from daemon: Cannot restart container e2da0a5efa1d: driver failed programming external connectivity on endpoint
**è§£å†³åŠæ³•ï¼š**é‡å¯dockeråå†é‡å¯å®¹å™¨

- **jenkinsæ‰§è¡Œshellåˆ é™¤é•œåƒå¤±è´¥ï¼Œå¦‚æœå­˜åœ¨å®¹å™¨ï¼Œéœ€è¦å…ˆåˆ é™¤å®¹å™¨**

Error response from daemon: conflict: unable to delete ef1d6b961fd1 (cannot be forced) - image is being used by running container a1fc71b0491e Build step 'Execute shell' marked build as failure


## æœ€åæ€»ç»“
æœ€ç»ˆå®ç°äº†åŸºäºDocker+Jenkins+Githubçš„æŒç»­é›†æˆï¼Œç°åœ¨æ˜¯åœ¨æœ¬åœ°æ‰“åŒ…ç”Ÿæˆé™æ€æ–‡ä»¶åå†æäº¤åˆ°Githubå»é›†æˆï¼Œåé¢è€ƒè™‘æ„å»ºèƒ½å¤Ÿè¿è¡Œé¡¹ç›®çš„rubyé•œåƒï¼Œé€šè¿‡jenkinsæ¥æ‰“åŒ…é¡¹ç›®ï¼›

è¿˜æœ‰å°±æ˜¯Githubä¸å¤ªç¨³å®šï¼Œæ¥ä¸‹æ¥æ‰“ç®—åœ¨Dockerä¸­æ­å»ºGitlab















