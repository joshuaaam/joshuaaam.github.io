---
layout: post
title: "Docker + JenkinsæŒç»­é›†æˆ"
author: "Fanqiang Meng"
categories: journal
tags: [documentation]
image: DSC_0803.JPG

---

## æ‹‰å–Jenkinsé•œåƒï¼Œè¿è¡Œå®¹å™¨
> ğŸ’¡ Tipsï¼šå¦‚æœéœ€è¦ç”¨åˆ°å®¿ä¸»æœºdockerå‘½ä»¤è®°å¾—æ˜ å°„

```bash
# æ‹‰å– Jenkins æ‹‰å–é•œåƒï¼Œè¿™é‡Œä½¿ç”¨æ”¯æŒ JDK8 çš„ç‰ˆæœ¬ã€‚
docker pull jenkins/jenkins:latest-jdk8

# è¿è¡Œå®¹å™¨
docker run -u root -d  --name dp-jenkins  jenkins/jenkins:latest-jdk8


docker run -u root -d -p 9999:8080 -v /var/run/docker.sock:/var/run/docker.sock  -v /usr/bin/docker:/usr/bin/docker --name docker-jenkins jenkins/jenkins:latest-jdk8
```
### æ˜ å°„å®¿ä¸»æœºDocker
```bash
-v /var/run/docker.sock:/var/run/docker.sock 

-v /usr/bin/docker:/usr/bin/docker
```
## é…ç½®Jenkins
> ğŸ’¡ Tipsï¼š8080ç«¯å£ä¸ºjenkinsæœåŠ¡é»˜è®¤çš„webè®¿é—®ç«¯å£ ï¼Œ-pæ˜ å°„å®¿ä¸»æœºçš„æŒ‡å®šç«¯å£

**è®¿é—®æœåŠ¡å™¨åœ°å€çš„å®¹å™¨æ˜ å°„ç«¯å£æŸ¥çœ‹jenkinsæœåŠ¡**
é¦–æ¬¡ç™»å½•éœ€è¦é»˜è®¤å¯†ç 
åœ¨å®¹å™¨ç»ˆç«¯åˆ°æç¤ºçš„å¯¹åº”ç›®å½•ä¸‹ä½¿ç”¨ `cat` å‘½ä»¤æŸ¥çœ‹**åˆå§‹å¯†ç **
ç™»å½•åä¼šæç¤ºå®‰è£…æ’ä»¶ï¼Œæˆ‘ç›´æ¥å®‰è£…é€šç”¨çš„æ’ä»¶
## åˆ›å»ºJenkinsä»»åŠ¡
ç®€å•çš„é…ç½®ä¸‹ä»»åŠ¡ï¼Œå°±æ˜¯é¡¹ç›®çš„åœ°å€ï¼Œè¿˜æœ‰è´¦å·å¯†ç æˆ–è€…å¯†é’¥è¿™äº›
é…ç½®å®Œå°±å¯ä»¥å°è¯•æ‰‹åŠ¨æ„å»ºäº†
æŸ¥çœ‹æ—¥å¿—è¾“å‡ºæ˜¯å¦æ„å»ºæˆåŠŸ
æ„å»ºæˆåŠŸï¼Œåœ¨`Workspace` ä¸­å°±å¯ä»¥çœ‹åˆ°æ‹‰ä¸‹æ¥çš„é¡¹ç›®äº†
## é…ç½®æ–‡ä»¶
### dockerfileé…ç½®
```bash
# ä¾èµ– nginx å®¹å™¨
FROM nginx
# ä½œè€…
MAINTAINER joshuaaam
# é¦–å…ˆåˆ é™¤ nginx default.conf æ–‡ä»¶
# RUN rm /etc/nginx/conf.d/default.conf
# ç”¨æœ¬åœ°çš„ default.conf æ›¿æ¢ nginx é•œåƒçš„é»˜è®¤é…ç½®
# ADD default.conf /etc/nginx/conf.d/
# å°†é¡¹ç›®æ‰“åŒ…åçš„ dist ç›®å½•ï¼Œæ‹·è´åˆ° default.conf æŒ‡å®šçš„å‘å¸ƒç›®å½• 
COPY _site/ /usr/share/nginx/html/
```
### nginxé…ç½®
> ğŸ’¡ Tipsï¼šå®¹å™¨é»˜è®¤çš„80ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºç«¯å£ï¼Œåœ¨å®¿ä¸»æœºnginxé…ç½®è½¬å‘

```bash
server {
    listen       80;
    server_name  10.115.89.112;
    # ä¿®æ”¹ docker æœåŠ¡å®¿ä¸»æœº IP

    location / {
        root   /usr/share/nginx/html;
        # é¡¹ç›®åœ°å€
        index  index.html index.htm;
        try_files $uri $uri/ /index.html =404;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   html;
    }
}
```
## Jenkinsæ„å»ºæ‰§è¡Œshell

```bash
# åˆ é™¤å†å²é•œåƒ

current_img=$(docker images | grep dp-docker-registry:5000/dp-console | awk '{print $3}')

if [ -z "$current_img" ]
then
      echo "\$current_img is empty"
else
      echo "\$current_img is NOT empty"
      docker rmi --force $current_img
fi

# æ„å»ºé•œåƒ  -t é•œåƒå -f æŒ‡å®šæ„å»ºæ–‡ä»¶  
docker build . -t jekyll-image -f ./dockerfile

# æ¨é€é•œåƒ
# docker push jekyll-image

# å¯åŠ¨å®¹å™¨
docker run --name jekyll_web -p 9998:80  -d -i jekyll-image
```

é‡æ–°æ‰‹åŠ¨æ„å»ºåè®¿é—®å¯¹åº”çš„æ˜ å°„ç«¯å£å°±å¯ä»¥çœ‹åˆ°é¡¹ç›®äº†
> ğŸ’¡ Tipsï¼šè¿™é‡Œè¦å…ˆé…ç½®å¥½åŸŸåçš„è½¬å‘


## æŒç»­é›†æˆ
## è¸©å‘

- **åœ¨**`**docker1.13.1**`** ä¸­ï¼Œ jenkinsæ„å»ºä¸­ä½¿ç”¨dokcer å‘½ä»¤æŠ¥é”™ Can't open /etc/sysconfig/docker**

åŸå› ï¼šdocker1.13.1  /usr/bin/ ä¸‹çœŸæ­£çš„binaryæ˜¯ docker-currentï¼Œæ˜ å°„è·¯å¾„åº”è¯¥ä¸º` -v /usr/bin/docker-current:/usr/bin/docker` 

- **æ²¡æœ‰åŠ æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„**

 docker build æ„å»ºé•œåƒè¦è®°å¾—åŠ ä¸Šæ„å»ºè·¯å¾„ï¼Œé»˜è®¤ `Dockerfile` ä¸ºæ„å»ºæ–‡ä»¶ï¼Œ-fï¼ˆæŒ‡å®šæ„å»ºæ–‡ä»¶ï¼‰-t (æŒ‡å®šé•œåƒå)

- **iptable è§„åˆ™ä¸¢å¤±ï¼Œç«¯å£æ˜ å°„å¤±æ•ˆ**

å› ä¸ºé‡å¯é˜²ç«å¢™ï¼Œå¯¼è‡´ `iptables`  è§„åˆ™ä¸¢å¤±ï¼Œç«¯å£æ˜ å°„å¤±æ•ˆï¼Œé‡å¯å®¹å™¨ä¹ŸæŠ¥é”™
Error response from daemon: Cannot restart container e2da0a5efa1d: driver failed programming external connectivity on endpoint
è§£å†³åŠæ³•ï¼šé‡å¯dockeråå†é‡å¯å®¹å™¨å°±è¡Œäº†

- 
















